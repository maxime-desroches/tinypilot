import SCons
from SCons.Builder import Builder
from SCons.Action import Action

Import('env', 'common', 'cereal', 'messaging', 'cython_dependencies')

env.Program('boardd', ['boardd.cc', 'panda.cc', 'pigeon.cc'], LIBS=['usb-1.0', common, cereal, messaging, 'pthread', 'zmq', 'capnp', 'kj'])
env.Library('libcan_list_to_can_capnp', ['can_list_to_can_capnp.cc'])

# env.Command(['boardd_api_impl.so', 'boardd_api_impl.cpp'],
#             cython_dependencies + ['libcan_list_to_can_capnp.a', 'boardd_api_impl.pyx', 'boardd_setup.py'],
#             "cd selfdrive/boardd && python3 boardd_setup.py build_ext --inplace")

cythonAction = Action("$CYTHONCOM")

def create_builder(env):
    try:
        cython = env['BUILDERS']['Cython']
    except KeyError:
        cython = SCons.Builder.Builder(
                  action = cythonAction,
                  emitter = {},
                  suffix = cython_suffix_emitter,
                  single_source = 1)
        env['BUILDERS']['Cython'] = cython

    return cython

def cython_suffix_emitter(env, source):
    return ".cc"

def generate(env):
    env["CYTHON"] = "cythonize"
    env["CYTHONCOM"] = "$CYTHON $CYTHONFLAGS $SOURCE"
    env["CYTHONCFILESUFFIX"] = ".cc"

    c_file, _ = SCons.Tool.createCFileBuilders(env)

    c_file.suffix['.pyx'] = cython_suffix_emitter
    c_file.add_action('.pyx', cythonAction)

    c_file.suffix['.py'] = cython_suffix_emitter
    c_file.add_action('.py', cythonAction)

    create_builder(env)

create_builder(env)
generate(env)

env.Cython('boardd_api_impl.pyx')


#env.Program('boardd_api_impl.o', 'boardd_api_impl.cpp')
# Gives below
# clang++ -o selfdrive/boardd/boardd_api_impl.o -c -std=c++1z -g -fPIC -O2 -Wunused -Werror -Wno-unknown-warning-option -Wno-deprecated-register -Wno-register -Wno-inconsistent-missing-override -Wno-c99-designator -Wno-reorder-init-list -Iexternal/tensorflow/include -I. -Iselfdrive -Iphonelibs/bzip2 -Iphonelibs/libyuv/include -Iphonelibs/openmax/include -Iphonelibs/json11 -I/usr/include/python3.8 -Iphonelibs/curl/include -Iphonelibs/libgralloc/include -Iphonelibs/android_frameworks_native/include -Iphonelibs/android_hardware_libhardware/include -Iphonelibs/android_system_core/include -Iphonelibs/linux/include -Iphonelibs/snpe/include -Iphonelibs/nanovg -Iselfdrive/common -Iselfdrive/camerad -Iselfdrive/camerad/include -Iselfdrive/loggerd/include -Iselfdrive/modeld -Iselfdrive/sensord -Iselfdrive/ui -Icereal/messaging -Icereal -Iopendbc/can -Iphonelibs/json11 selfdrive/boardd/boardd_api_impl.cpp            
# clang++ -o selfdrive/boardd/boardd_api_impl.o -Wl,-rpath=/home/batman/openpilot/phonelibs/snpe/x86_64-linux-clang -Wl,-rpath=/home/batman/openpilot/external/tensorflow/lib -Wl,-rpath=/home/batman/openpilot/cereal -Wl,-rpath=/home/batman/openpilot/selfdrive/common selfdrive/boardd/boardd_api_impl.o -Lphonelibs/snpe/x86_64-linux-clang -Lphonelibs/libyuv/x64/lib -Lexternal/tensorflow/lib -Lcereal -Lselfdrive/common -L/usr/lib -L/usr/local/lib -Lcereal -Lselfdrive/common -Lphonelibs



env["CPPPATH"]+=["/home/batman/.pyenv/versions/3.8.2/include/python3.8"]
env["LINKFLAGS"]=["-pthread", "-shared"]
env["LIBPATH"]+=["#selfdrive/boardd"]

env.Program('boardd_api_impl.so', 'boardd_api_impl.cpp', LIBS=["can_list_to_can_capnp", 'capnp'])

# clang++ -o selfdrive/boardd/boardd_api_impl.o -c -std=c++1z -g -fPIC -O2 -Wunused -Werror -Wno-unknown-warning-option -Wno-deprecated-register -Wno-register -Wno-inconsistent-missing-override -Wno-c99-designator -Wno-reorder-init-list -Iexternal/tensorflow/include -I. -Iselfdrive -Iphonelibs/bzip2 -Iphonelibs/libyuv/include -Iphonelibs/openmax/include -Iphonelibs/json11 -I/usr/include/python3.8 -Iphonelibs/curl/include -Iphonelibs/libgralloc/include -Iphonelibs/android_frameworks_native/include -Iphonelibs/android_hardware_libhardware/include -Iphonelibs/android_system_core/include -Iphonelibs/linux/include -Iphonelibs/snpe/include -Iphonelibs/nanovg -Iselfdrive/common -Iselfdrive/camerad -Iselfdrive/camerad/include -Iselfdrive/loggerd/include -Iselfdrive/modeld -Iselfdrive/sensord -Iselfdrive/ui -Icereal/messaging -Icereal -Iopendbc/can -Iphonelibs/json11 -I/home/batman/.pyenv/versions/3.8.2/include/python3.8 selfdrive/boardd/boardd_api_impl.cpp
# clang++ -o selfdrive/boardd/boardd_api_impl.so -pthread -shared -Wl,-rpath=/home/batman/openpilot/phonelibs/snpe/x86_64-linux-clang -Wl,-rpath=/home/batman/openpilot/external/tensorflow/lib -Wl,-rpath=/home/batman/openpilot/cereal -Wl,-rpath=/home/batman/openpilot/selfdrive/common selfdrive/boardd/boardd_api_impl.o -Lphonelibs/snpe/x86_64-linux-clang -Lphonelibs/libyuv/x64/lib -Lexternal/tensorflow/lib -Lcereal -Lselfdrive/common -L/usr/lib -L/usr/local/lib -Lcereal -Lselfdrive/common -Lphonelibs

#Prvi del izgleda ok, drugi potrebuje popravek







# -I/home/batman/.pyenv/versions/3.8.2/include/python3.8
# -L/home/batman/.pyenv/versions/3.8.2/lib

# SOLUTION:
# clang -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/batman/.pyenv/versions/3.8.2/include/python3.8 -c boardd_api_impl.cpp -o build/temp.linux-x86_64-3.8/boardd_api_impl.o -std=c++1z -Wno-nullability-completeness
# clang -pthread -shared -L/home/batman/.pyenv/versions/3.8.2/lib -Wl,-rpath=/home/batman/.pyenv/versions/3.8.2/lib -L/home/batman/.pyenv/versions/3.8.2/lib -Wl,-rpath=/home/batman/.pyenv/versions/3.8.2/lib build/temp.linux-x86_64-3.8/boardd_api_impl.o -L./ -L/home/batman/.pyenv/versions/3.8.2/lib -lcan_list_to_can_capnp -lcapnp -lkj -o /home/batman/openpilot/selfdrive/boardd/boardd_api_impl.so

#env.Command("build/temp.linux-x86_64-3.8/boardd_api_impl.o", "boardd_api_impl.cpp", "cd selfdrive/boardd && gcc -pthread -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/batman/.pyenv/versions/3.8.2/include/python3.8 -c boardd_api_impl.cpp -o build/temp.linux-x86_64-3.8/boardd_api_impl.o -std=c++1z -Wno-nullability-completeness")
#env.Command("boardd_api_impl.so", "build/temp.linux-x86_64-3.8/boardd_api_impl.o", "cd selfdrive/boardd && g++ -pthread -shared -L/home/batman/.pyenv/versions/3.8.2/lib -Wl,-rpath=/home/batman/.pyenv/versions/3.8.2/lib -L/home/batman/.pyenv/versions/3.8.2/lib -Wl,-rpath=/home/batman/.pyenv/versions/3.8.2/lib build/temp.linux-x86_64-3.8/boardd_api_impl.o -L./ -L/home/batman/.pyenv/versions/3.8.2/lib -lcan_list_to_can_capnp -lcapnp -lkj -o /home/batman/openpilot/selfdrive/boardd/boardd_api_impl.so")
